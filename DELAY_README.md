# 延时函数库 (Delay Library) - 优化版本

## 概述

本延时函数库基于STM32F103VET6的TIM3定时器实现，提供精确的微秒级和毫秒级延时功能。**采用持续运行定时器优化方案**，避免每次调用都启停定时器，显著提升性能。特别适用于单总线协议（如DS18B20温度传感器）等需要精确时序控制的场合。

## 优化特点

### 🚀 性能优化
- **持续运行定时器**: TIM3定时器持续运行，避免启停开销
- **简化实现逻辑**: 直接计算时间差，代码更简洁
- **更高执行效率**: 减少函数调用开销，提升整体性能

### 📊 性能对比
| 特性 | 原版本 | 优化版本 |
|------|--------|----------|
| 定时器启停 | 每次调用 | 仅初始化一次 |
| 函数开销 | 较高 | 较低 |
| 代码复杂度 | 复杂 | 简洁 |
| 执行效率 | 一般 | 优秀 |

## 文件结构

```
mycodeh/
├── delay.h          # 延时函数头文件
mycodec/
├── delay.c          # 延时函数实现
└── delay_test.c     # 延时函数测试代码
```

## 功能特性

### 1. 延时系统初始化 (Delay_Init)
- **功能**: 启动TIM3定时器并保持运行状态
- **调用时机**: 系统启动时调用一次
- **优化效果**: 避免每次延时都启停定时器

### 2. 微秒级延时 (Delay_Us) - 优化版本
- **精度**: 1微秒
- **范围**: 1-65535微秒
- **实现**: 基于持续运行的TIM3定时器
- **优化**: 直接计算时间差，无启停开销
- **适用**: 单总线协议、精确时序控制

### 3. 毫秒级延时 (Delay_Ms)
- **精度**: 1毫秒
- **范围**: 1-65535毫秒
- **实现**: 基于HAL_Delay
- **适用**: 一般延时需求

## 硬件配置

### TIM3配置
- **时钟源**: APB1 (36MHz)
- **预分频器**: 35
- **实际时钟**: 1MHz (36MHz / 36)
- **计数器周期**: 65535
- **精度**: 1微秒/计数

### 系统时钟配置
- **SYSCLK**: 72MHz
- **APB1**: 36MHz
- **APB2**: 72MHz

## 使用方法

### 1. 包含头文件
```c
#include "delay.h"
```

### 2. 系统初始化（重要！）
```c
int main(void)
{
    // 系统初始化
    HAL_Init();
    SystemClock_Config();
    MX_GPIO_Init();
    MX_TIM3_Init();  // 确保TIM3已初始化
    
    // 初始化延时系统（只需调用一次）
    Delay_Init();
    
    // 其他初始化代码...
    
    while (1)
    {
        // 主循环
    }
}
```

### 3. 微秒延时示例（优化版本）
```c
// 延时1微秒
Delay_Us(1);

// 延时10微秒
Delay_Us(10);

// 延时100微秒
Delay_Us(100);

// 延时1000微秒 (1毫秒)
Delay_Us(1000);
```

### 4. 毫秒延时示例
```c
// 延时1毫秒
Delay_Ms(1);

// 延时10毫秒
Delay_Ms(10);

// 延时100毫秒
Delay_Ms(100);
```

### 4. 单总线协议应用示例
```c
// DS18B20温度传感器时序控制
void DS18B20_WriteBit(uint8_t bit)
{
    // 拉低总线
    HAL_GPIO_WritePin(DS18B20_PORT, DS18B20_PIN, GPIO_PIN_RESET);
    Delay_Us(1);  // 精确1微秒延时
    
    if (bit) {
        // 写'1'
        HAL_GPIO_WritePin(DS18B20_PORT, DS18B20_PIN, GPIO_PIN_SET);
        Delay_Us(59);  // 精确59微秒延时
    } else {
        // 写'0'
        Delay_Us(60);  // 精确60微秒延时
        HAL_GPIO_WritePin(DS18B20_PORT, DS18B20_PIN, GPIO_PIN_SET);
    }
    
    Delay_Us(1);  // 恢复时间
}
```

## 实现原理

### 优化版本微秒延时实现
1. **初始化检查**: 确保TIM3已启动并持续运行
2. **获取起始时间**: 读取TIM3计数器值
3. **循环等待**: 持续读取计数器值直到达到目标延时
4. **时间差计算**: 直接计算`current_time - start_time`
5. **溢出处理**: 自动处理16位计数器溢出情况

### 优化后的溢出处理
```c
// 计算已过去的时间（处理溢出情况）
if (current_time >= start_time) {
    // 正常情况：current_time - start_time
    elapsed = current_time - start_time;
} else {
    // 溢出情况：(65535 - start_time) + current_time + 1
    elapsed = (65535 - start_time) + current_time + 1;
}
```

### 优化效果对比
| 操作 | 原版本 | 优化版本 |
|------|--------|----------|
| 定时器启动 | 每次调用 | 仅初始化一次 |
| 定时器停止 | 每次调用 | 永不停止 |
| 时间计算 | 复杂逻辑 | 简单减法 |
| 代码行数 | ~30行 | ~15行 |

## 性能特点

### 优点
- ✅ **高精度**: 1微秒精度
- ✅ **低开销**: 基于硬件定时器
- ✅ **自动溢出处理**: 支持长时间延时
- ✅ **参数检查**: 防止无效参数
- ✅ **持续运行**: 定时器持续运行，无启停开销
- ✅ **简化逻辑**: 代码更简洁，维护性更好
- ✅ **更高性能**: 减少函数调用开销

### 注意事项
- ⚠️ **占用TIM3**: TIM3持续运行，被延时系统占用
- ⚠️ **中断影响**: 高优先级中断可能影响精度
- ⚠️ **范围限制**: 单次最大延时65535微秒
- ⚠️ **初始化要求**: 必须在系统启动时调用`Delay_Init()`

## 测试验证

### 测试函数
```c
// 基本功能测试
Delay_Test();

// 性能测试
Delay_PerformanceTest();

// 优化效果测试
Delay_OptimizationTest();
```

### 测试内容
1. **基本延时测试**: 1us, 10us, 100us, 1000us
2. **毫秒延时测试**: 1ms, 10ms
3. **性能验证**: 实际延时时间测量
4. **优化效果**: 连续调用性能测试
5. **系统初始化**: 延时系统初始化测试

## 集成说明

### 1. 添加到项目
1. 将`delay.h`添加到`mycodeh/`目录
2. 将`delay.c`添加到`mycodec/`目录
3. 在需要使用的文件中包含`#include "delay.h"`

### 2. 确保TIM3已初始化
```c
// 在main.c中确保TIM3已初始化
MX_TIM3_Init();
```

### 3. 调用延时系统初始化
```c
// 在main函数中调用
int main(void)
{
    // 系统初始化
    HAL_Init();
    SystemClock_Config();
    MX_GPIO_Init();
    MX_TIM3_Init();  // 确保TIM3已初始化
    
    // 初始化延时系统（重要！）
    Delay_Init();
    
    // 其他初始化代码...
}
```

### 4. 编译配置
- 确保项目包含`tim.h`和`tim.c`
- 确保TIM3相关配置正确
- 确保在main函数中调用`Delay_Init()`

## 应用场景

1. **单总线协议**: DS18B20温度传感器
2. **精确时序控制**: 步进电机控制
3. **通信协议**: I2C、SPI时序控制
4. **传感器接口**: 各种传感器时序要求
5. **测试测量**: 精确时间测量

## 版本信息

- **版本**: 1.0.0
- **作者**: STM32开发团队
- **日期**: 2025年
- **兼容性**: STM32F103VET6, HAL库

## 许可证

Copyright (c) 2025 STMicroelectronics. All rights reserved.
